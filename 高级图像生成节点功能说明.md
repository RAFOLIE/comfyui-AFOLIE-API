# 🎨 AFOLIE 高级图像生成节点功能说明

## 概述

AFOLIE 高级图像生成节点是一个功能全面的 ComfyUI 自定义节点，支持 Gemini 和 OpenAI 双协议，具备批量生成、多图参考、智能参数处理等高级功能。

## 核心特性

### 1. 双协议支持

#### Gemini 协议
- 支持 Gemini 系列模型
- 自动检测宽高比
- 支持多图融合（最多 9 张参考图像）
- 支持 imageSize 参数（1K/2K/4K）

#### OpenAI 协议
- 支持 DALL-E、Flux 等模型
- 自动转换宽高比为标准尺寸
- 支持 top_p 和 seed 参数
- 兼容标准 OpenAI API 格式

### 2. 批量生成

- **批次大小**：1-8 张图片
- **并发处理**：使用线程池同时处理多个请求
- **可配置工作线程**：通过 config.ini 的 max_workers 参数调整
- **部分失败处理**：部分批次失败时，其他批次继续执行

### 3. 多图参考

- **最多支持 9 张输入图像**
- **自动收集**：自动检测并收集所有连接的图像输入
- **自动检测宽高比**：当宽高比设置为 Auto 时，从第一张参考图像自动检测
- **图生图支持**：用于图像编辑、风格迁移等场景

### 4. 智能参数处理

#### 宽高比自动检测
```python
当 aspect_ratio = "Auto" 时：
- 从第一张参考图像获取实际宽高比
- 自动匹配最接近的标准宽高比（1:1, 16:9, 9:16 等）
```

#### OpenAI 尺寸映射
```
1:1  → 1024x1024
16:9 → 1024x576
9:16 → 576x1024
2:3  → 768x1152
3:2  → 1152x768
4:3  → 1024x768
3:4  → 768x1024
4:5  → 832x1040
5:4  → 1040x832
21:9 → 1344x576
Auto → 1024x1024
```

#### 分辨率参数
- Gemini 协议：使用 imageSize 参数（1K/2K/4K）
- OpenAI 协议：通过 size 参数指定像素尺寸

### 5. 错误处理

#### 详细错误信息
- 显示错误类型和原因
- 显示 API 响应内容（前 300 字符）
- 批次级别的错误跟踪

#### 部分失败处理
- 单个批次失败不影响其他批次
- 返回成功生成的所有图片
- 在输出文本中报告失败批次数量

#### 错误画布
- 生成失败时显示错误信息的可视化画布
- 便于调试和问题定位

### 6. 进度显示

#### 控制台日志
```
🎨 高级图像生成任务
═════════════════════════════
协议: Gemini
模型: gemini-2.5-flash-image
批次大小: 4
宽高比: Auto
分辨率: 2K
参考图像: 2 张
种子: 12345
═════════════════════════════
```

#### 完成统计
```
✓ 任务完成
  成功生成: 4 张
  总耗时: 15.23s
  平均速度: 3.81s/张
```

### 7. 中断支持

- 集成 ComfyUI 原生取消机制
- 定期检查中断状态（每 0.25 秒）
- 支持在请求发送过程中取消
- 支持在线程池执行过程中取消

## 参数说明

### 必需参数

| 参数 | 类型 | 说明 | 默认值 |
|------|------|------|--------|
| **prompt** | STRING | 文本提示词，支持多行输入 | - |
| **api_key** | STRING | API 密钥（可选，可用 config.ini 配置） | "" |
| **model_type** | 选择 | 模型名称 | gemini-3-pro-image-preview |
| **batch_size** | INT | 批次大小（1-8），一次生成图片数量 | 1 |
| **aspect_ratio** | 选择 | 宽高比 | Auto |

**注意**：`api_base_url`（API 服务地址）从配置文件 config.ini 的 `[nebula]` 部分读取，不在 UI 中显示。所有模型类型使用相同的 API 地址。

### 可选参数

| 参数 | 类型 | 说明 | 默认值 |
|------|------|------|--------|
| **seed** | INT | 随机种子（-1 为随机，固定值可复现） | -1 |
| **top_p** | FLOAT | 采样参数（0.0-1.0），控制多样性 | 0.95 |
| **imageSize** | 选择 | 分辨率：无/1K/2K/4K | 1K |
| **image_1~9** | IMAGE | 最多支持 9 张参考图像（图生图） | - |
| **超时秒数** | INT | API 请求超时时间（0-1800秒） | 1200 |
| **绕过代理** | BOOLEAN | 梯子不稳定时开启 | False |
| **api_protocol** | 选择 | 选择 Gemini 或 OpenAI 协议 | Gemini |

## 输出内容

### 1. images (IMAGE)
- 生成的图像张量
- 格式：[N, H, W, C]
- 类型：torch.FloatTensor
- 范围：0.0-1.0

### 2. text (STRING)
包含以下信息的文本：
```
✅ 成功生成 4 张图像
协议: Gemini
模型: gemini-2.5-flash-image
宽高比: 16:9
分辨率: 2K
批次大小: 4
总耗时: 15.23s，平均 3.81s/张
```

如果有部分失败，会显示：
```
⚠️ 部分请求失败 (2 个)
```

## 使用场景

### 1. 文本生成图像

**场景描述**：通过文本描述生成图片

**配置示例**：
```
prompt: "一只可爱的橙色小猫坐在花园里，阳光明媚，高质量摄影"
model_type: "gemini-2.5-flash-image"
batch_size: 1
aspect_ratio: "1:1"
imageSize: "2K"
```

**输出**：1 张 2K 分辨率的正方形图片

### 2. 图像编辑

**场景描述**：使用参考图像进行修改

**配置示例**：
```
prompt: "将背景改为海滩"
model_type: "gemini-3-pro-image-preview"
image_1: [原始图像]
aspect_ratio: "Auto"
```

**输出**：编辑后的图像，保持原始宽高比

### 3. 风格迁移

**场景描述**：结合文本和图像生成特定风格的作品

**配置示例**：
```
prompt: "应用梵高的画风"
image_1: [参考图像 1]
image_2: [参考图像 2 - 风格参考]
batch_size: 4
```

**输出**：4 张不同变体的风格化图像

### 4. 批量创作

**场景描述**：一次性生成多张图片

**配置示例**：
```
prompt: "未来城市夜景，霓虹灯，赛博朋克风格"
batch_size: 8
aspect_ratio: "21:9"
seed: 42
```

**输出**：8 张同一主题不同变体的图像

### 5. 多模型切换

**场景描述**：在不同 AI 模型间灵活切换

**配置示例 1（Gemini）**：
```
model_type: "gemini-2.5-flash-image"
api_protocol: "Gemini"
```

**配置示例 2（OpenAI）**：
```
model_type: "dalle-3"
api_protocol: "OpenAI"
```

## 配置文件

### config.ini

```ini
[nebula]
api_key = sk-your-api-key-here
api_base_url = https://llm.ai-nebula.com/v1
max_workers = 4
```

**参数说明**：
- `api_key`：默认 API Key，节点中留空时使用
- `api_base_url`：API 服务地址
- `max_workers`：最大并发工作线程数（建议 2-8）

## 架构设计

### 双客户端架构

```
ImageGenerationNode
├── GeminiApiClient
│   ├── create_request_data()
│   └── send_request()
└── OpenAIApiClient
    ├── create_request_data()
    └── send_request()
```

### 并发处理

```
BatchGenerationRunner
├── ThreadPoolExecutor
│   ├── 批次 1
│   ├── 批次 2
│   └── ...
└── 结果收集与排序
```

### 图像处理

```
ImageCodec
├── prepare_input_images()
├── base64_to_tensor_parallel()
└── tensor_to_base64()
```

## 技术细节

### 中断检查机制

```python
def _ensure_not_interrupted(self):
    comfy.model_management.throw_exception_if_processing_interrupted()
```

- 每 0.25 秒检查一次
- 支持在网络请求期间中断
- 支持在线程池执行期间中断

### 线程池执行

```python
with ThreadPoolExecutor(max_workers=max_workers) as executor:
    futures = {}
    for batch_num in range(batch_size):
        future = executor.submit(_process_batch, batch_num, 1)
        futures[future] = batch_num
    
    for future in as_completed(futures):
        result = future.result()
        # 处理结果
```

### 响应解析

支持多种响应格式：
1. 标准 OpenAI 格式：`{ "data": [ { "b64_json": "..." } ] }`
2. 嵌套 data 格式：`{ "data": { "data": [ ... ] } }`
3. URL 格式：`{ "data": [ { "url": "https://..." } ] }`

## 常见问题

### Q1: 批量生成时部分失败怎么办？

**A**: 节点会继续处理其他批次，返回所有成功生成的图片。输出文本会显示失败批次数量。

### Q2: 如何提高生成速度？

**A**:
1. 增加 config.ini 中的 max_workers（建议不超过 CPU 核心数）
2. 使用较小的 batchSize
3. 使用较快的模型（如 gemini-2.5-flash-image）

### Q3: 宽高比 Auto 的工作原理？

**A**: 从第一张参考图像提取实际宽高比，然后匹配最接近的标准宽高比。如果没有参考图像，则使用 1:1。

### Q4: 如何固定生成结果？

**A**: 设置 seed 参数为固定值（非 -1），并保持其他参数不变。

### Q5: 绕过代理选项什么时候使用？

**A**: 当使用代理连接不稳定时，勾选此选项可以绕过系统代理设置。

## 版本信息

- **当前版本**：v1.1.0
- **发布日期**：2025-12-28
- **兼容性**：ComfyUI 最新版本

## 更新日志

### v1.1.0 (2025-12-28)
- 新增 🎨 AFOLIE 高级图像生成节点
- 支持 Gemini 和 OpenAI 双协议
- 支持批量生成（1-8张图片）
- 支持最多 9 张参考图像输入
- 新增并发处理和线程池支持
- 新增智能参数处理和宽高比自动检测
- 新增详细的错误处理和进度显示
